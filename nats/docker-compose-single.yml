version: "3.8"

x-env:
  nats: &nats
    image: nats:2.8-alpine3.15
    environment:
      MY_NATS_SERVER_NAME: "${MY_NATS_SERVER_NAME}"
      MY_NATS_ROUTE_USERNAME: "${MY_NATS_ROUTE_USERNAME}"
      MY_NATS_ROUTE_PASSWORD: "${MY_NATS_ROUTE_PASSWORD}"
      MY_NATS_NKEY_USER: "${MY_NATS_NKEY_USER}"
      MY_NATS_NKEY_SEED: "${MY_NATS_NKEY_SEED}"
      MY_NATS_USERNAME: "${MY_NATS_USERNAME}"
      MY_NATS_PASSWORD: "${MY_NATS_PASSWORD}"
      MY_MQTT_USERNAME: "${MY_MQTT_USERNAME}"
      MY_MQTT_PASSWORD: "${MY_MQTT_PASSWORD}"
    restart:
      unless-stopped

services:
  nats:
    <<: *nats
    command: "--name ${MY_NATS_SERVER_NAME} -c /etc/nats/nats-single.conf -js -D"
    ports:
      # for clients
      - 4222:4222
      # an HTTP management port for information reporting
      - 8222:8222
      # mqtt
      - 1883:1883
      # websocket
      - 8080:8080
    volumes:
      - $PWD/nats-single.conf:/etc/nats/nats-single.conf:ro
      - $PWD/cert/my-domain.com/ca.crt:/etc/nats/ca.crt:ro
      - $PWD/cert/my-domain.com/server.crt:/etc/nats/server.crt:ro
      - $PWD/cert/my-domain.com/server.key:/etc/nats/server.key:ro
      - data:/data/jetstream

volumes:  
  data:
