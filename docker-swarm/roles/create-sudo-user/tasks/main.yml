---
- name: get user info from environment variable
  set_fact:
    vm_username: "{{ lookup('env', 'VM_USERNAME') }}"
    vm_password: "{{ lookup('env', 'VM_PASSWORD') }}"

- name: create user vm_username
  become: true
  become_user: root
  user: name={{ vm_username }}
        password={{ vm_password }}
        create_home=yes
        groups=wheel
        shell=/bin/bash
        generate_ssh_key=yes
        state=present

- name: add sudoer
  become: true
  become_user: root
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ vm_username }}
    line: '{{ vm_username }} ALL=(ALL) NOPASSWD: ALL'
    state: present
    mode: 0440
    create: yes
    validate: 'visudo -cf %s'